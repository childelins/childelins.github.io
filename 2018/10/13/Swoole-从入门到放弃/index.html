
<!DOCTYPE html>
<html lang="" class="loading">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>childelins&#39;s blog</title>

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="google" content="notranslate" />
    
    <meta name="description" content="简介Swoole 使用纯 C 语言编写，是面向生产环境的 PHP 异步网络通信引擎。使 PHP 开发人员可以编写高性能的异步并发 TCP、UDP、Unix Socket、HTTP，WebSocket,"> 
    <meta name="author" content="chidelins"> 
    <link rel="alternative" href="atom.xml" title="childelins&#39;s blog" type="application/atom+xml"> 
    
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
    <link rel="stylesheet" href="/css/diaspora.css">
</head>

<body class="loading">
    <div id="loader"></div>
    <div id="single">
    <div id="top" style="display: block;">
    <div class="bar" style="width: 0;"></div>
    <a class="icon-home image-icon" href="javascript:;"></a>
    <div title="播放/暂停" class="icon-play"></div>
    <h3 class="subtitle">Swoole 从入门到放弃</h3>
    <div class="social">
        <!--<div class="like-icon">-->
            <!--<a href="javascript:;" class="likeThis active"><span class="icon-like"></span><span class="count">76</span></a>-->
        <!--</div>-->
        <div>
            <div class="share">
                <a title="获取二维码" class="icon-scan" href="javascript:;"></a>
            </div>
            <div id="qr"></div>
        </div>
    </div>
    <div class="scrollbar"></div>
</div>
    <div class="section">
        <div class="article">
    <div class='main'>
        <h1 class="title">Swoole 从入门到放弃</h1>
        <div class="stuff">
            <span>十月 13, 2018</span>
            

        </div>
        <div class="content markdown">
            <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>Swoole 使用纯 C 语言编写，是面向生产环境的 PHP 异步网络通信引擎。使 PHP 开发人员可以编写高性能的异步并发 TCP、UDP、Unix Socket、HTTP，WebSocket 服务。</p>
<ul>
<li>PHP 异步网络通信引擎</li>
<li>最终编译为 so 文件作为 PHP 的扩展</li>
</ul>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><ol>
<li>下载</li>
</ol>
<blockquote>
<p><a href="https://github.com/swoole/swoole-src/releases" target="_blank" rel="noopener">https://github.com/swoole/swoole-src/releases</a></p>
</blockquote>
<ol start="2">
<li>编译安装</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> swoole/</span><br><span class="line">phpize</span><br><span class="line">./configure --<span class="built_in">enable</span>-swoole-debug --with-php-config=/usr/<span class="built_in">local</span>/php/bin/php-config</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>配置</li>
</ol>
<p>编译安装成功后，修改 <code>php.ini</code> 加入<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">extension=swoole.so</span><br></pre></td></tr></table></figure></p>
<p>通过 <code>php -m</code> 来查看是否成功加载了 swoole。</p>
<h1 id="快速起步"><a href="#快速起步" class="headerlink" title="快速起步"></a>快速起步</h1><h2 id="TCP-服务"><a href="#TCP-服务" class="headerlink" title="TCP 服务"></a>TCP 服务</h2><p><code>swoole_server</code> 是异步服务器，所以是通过监听事件的方式来编写程序的。当对应的事件发生时底层会主动回调指定的PHP函数。如当有新的TCP连接进入时会执行 <code>onConnect</code> 事件回调，当某个连接向服务器发送数据时会回调 <code>onReceive</code> 函数。</p>
<p>tcp_server.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建 Server 对象，监听 127.0.0.1:9501 端口</span></span><br><span class="line">$serv = <span class="keyword">new</span> swoole_server(<span class="string">'127.0.0.1'</span>, <span class="number">9501</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置运行时参数</span></span><br><span class="line">$serv-&gt;set([</span><br><span class="line">    <span class="string">'worker_num'</span> =&gt; <span class="number">8</span>, <span class="comment">// worker进程数</span></span><br><span class="line">    <span class="string">'max_request'</span> =&gt; <span class="number">10000</span>,</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听连接进入事件</span></span><br><span class="line"><span class="comment">// fd: 客户端连接的唯一标识</span></span><br><span class="line"><span class="comment">// reactor_id: 线程id</span></span><br><span class="line">$serv-&gt;on(<span class="string">'connect'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($serv, $fd, $reactor_id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"Client: &#123;$reactor_id&#125; - &#123;$fd&#125; - Connect.\n"</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听数据接收事件</span></span><br><span class="line">$serv-&gt;on(<span class="string">'receive'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($serv, $fd, $from_id, $data)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 服务段发送消息给客户端</span></span><br><span class="line">    $serv-&gt;send($fd, <span class="string">"Server: &#123;$from_id&#125; - &#123;$fd&#125; -"</span> . $data);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//监听连接关闭事件</span></span><br><span class="line">$serv-&gt;on(<span class="string">'close'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($serv, $fd)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"Client: &#123;$fd&#125; - Close.\n"</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//启动服务器</span></span><br><span class="line">$serv-&gt;start();</span><br></pre></td></tr></table></figure>
<p>运行程序：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php tcp_server.php</span><br></pre></td></tr></table></figure>
<blockquote>
<p>使用 <code>netstat -anp | grep 端口</code>，查看端口是否已经被打开处于 <code>Listening</code> 状态</p>
</blockquote>
<p>这时可以使用 <code>telnet</code> 工具连接到服务器:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[vagrant@docker-host ~]$ telnet 127.0.0.1 9501</span><br><span class="line">Trying 127.0.0.1...</span><br><span class="line">Connected to 127.0.0.1.</span><br><span class="line">Escape character is &apos;^]&apos;.</span><br><span class="line">hello</span><br><span class="line">Server: 0 - 1 -hello</span><br></pre></td></tr></table></figure></p>
<p>也可以创建一个TCP客户端，来连接到我们的服务器。</p>
<p>tcp_client.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$client = <span class="keyword">new</span> swoole_client(SWOOLE_SOCK_TCP);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 连接到服务器</span></span><br><span class="line"><span class="keyword">if</span> (!$client-&gt;connect(<span class="string">'127.0.0.1'</span>, <span class="number">9501</span>)) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'连接失败'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// php cli常量</span></span><br><span class="line">fwrite(STDOUT, <span class="string">'请输入消息：'</span>);</span><br><span class="line">$data = trim(fgets(STDIN));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 向服务器发送数据</span></span><br><span class="line"><span class="keyword">if</span> (!$client-&gt;send($data)) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'发送失败'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从服务器接收数据</span></span><br><span class="line">$data = $client-&gt;recv();</span><br><span class="line"><span class="keyword">if</span> (!$data) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'接收失败'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> $data . PHP_EOL;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 关闭连接</span></span><br><span class="line">$client-&gt;close();</span><br></pre></td></tr></table></figure>
<p>运行程序：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php tcp_client.php</span><br></pre></td></tr></table></figure></p>
<p>运行结果：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[vagrant@docker-host client]$ php tcp_client.php </span><br><span class="line">请输入消息：hello</span><br><span class="line">Server: 0 - 2 -hello</span><br></pre></td></tr></table></figure></p>
<h2 id="UDP-服务"><a href="#UDP-服务" class="headerlink" title="UDP 服务"></a>UDP 服务</h2><p>略</p>
<h2 id="HTTP-服务"><a href="#HTTP-服务" class="headerlink" title="HTTP 服务"></a>HTTP 服务</h2><p>Swoole内置Http服务器的支持，通过几行代码即可写出一个异步非阻塞多进程的Http服务器。Http服务器只需要关注请求响应即可，所以只需要监听一个 <code>onRequest</code> 事件。当有新的Http请求进入就会触发此事件。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$http = <span class="keyword">new</span> swoole_http_server(<span class="string">'0.0.0.0'</span>, <span class="number">8811</span>);</span><br><span class="line"></span><br><span class="line">$http-&gt;set([</span><br><span class="line">    <span class="string">'document_root'</span> =&gt; <span class="string">'/home/vagrant/learn/learning/swoole/data'</span>, <span class="comment">// 配置静态文件根目录</span></span><br><span class="line">    <span class="string">'enable_static_handler'</span> =&gt; <span class="keyword">true</span>,</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line">$http-&gt;on(<span class="string">'request'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($request, $response)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 获取请求参数</span></span><br><span class="line">    $gets = $request-&gt;get;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置cookie</span></span><br><span class="line">    $response-&gt;cookie(<span class="string">'swoole'</span>, <span class="string">'123'</span>, time() + <span class="number">1800</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 输出一段 HTML内容，并结束此请求</span></span><br><span class="line">    $response-&gt;end(<span class="string">'&lt;h1&gt; Hello Swoole. #'</span> . rand(<span class="number">1000</span>, <span class="number">9999</span>) . <span class="string">'&lt;/h1&gt;'</span> . json_encode($gets));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">$http-&gt;start();</span><br></pre></td></tr></table></figure>
<p>运行程序：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php http_server.php</span><br></pre></td></tr></table></figure></p>
<p>打开浏览器 <code>http://192.168.10.15:8811/?aaa=123&amp;bbb=456</code> 查看请求结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Hello Swoole. #6898</span><br><span class="line"></span><br><span class="line">&#123;&quot;aaa&quot;:&quot;123&quot;,&quot;bbb&quot;:&quot;456&quot;&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以在静态文件目录下增加 <code>index.html</code> 文件,  访问 <code>http://192.168.10.15:8811/index.html</code> ,此时不走 <code>onRequest</code> 回调：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">我是通过 http server 获取的静态资源内容</span><br></pre></td></tr></table></figure></p>
<h2 id="WebSocket-服务"><a href="#WebSocket-服务" class="headerlink" title="WebSocket 服务"></a>WebSocket 服务</h2><p><strong>什么是 WebSocket</strong></p>
<p>WebSocket 协议是基于 TCP 的一种新的网络协议。它实现了浏览器与服务器的全双工（full-duplex）通信  —— <strong><em>允许服务器主动发送消息给客户端</em></strong>。</p>
<p><strong>为什么需要 WebSocket</strong></p>
<p>缺陷：HTTP 的通信只能由客户端发起</p>
<p><strong>WebSocket 的特点</strong></p>
<ul>
<li>建立在TCP协议之上 </li>
<li>性能开销小通信高效</li>
<li>客户端可以和任意服务器通信</li>
<li>协议标识符 ws wss</li>
<li>持久化网络通信协议</li>
</ul>
<hr>
<p>WebSocket服务器是建立在Http服务器之上的长连接服务器，客户端首先会发送一个Http的请求与服务器进行握手。握手成功后会触发 <code>onOpen</code> 事件，表示连接已就绪。建立连接后客户端与服务器端就可以双向通信了。</p>
<p>ws_server.php</p>
<p>面向过程写法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建 websocket 服务器对象，监听 0.0.0.0:9502 端口</span></span><br><span class="line">$server = <span class="keyword">new</span> swoole_websocket_server(<span class="string">'0.0.0.0'</span>, <span class="number">9502</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听 WebSocket 连接打开事件</span></span><br><span class="line">$server-&gt;on(<span class="string">'open'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($server, $request)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"server: handshake success with fd&#123;$request-&gt;fd&#125;\n"</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听 WebSocket 消息事件</span></span><br><span class="line">$server-&gt;on(<span class="string">'message'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($server, $frame)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"receive from &#123;$frame-&gt;fd&#125;:&#123;$frame-&gt;data&#125;,opcode:&#123;$frame-&gt;opcode&#125;,fin:&#123;$frame-&gt;finish&#125;\n"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 服务器发送消息给客户端</span></span><br><span class="line">    $server-&gt;push($frame-&gt;fd, <span class="string">'this is server'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听 WebSocket 连接关闭事件</span></span><br><span class="line">$server-&gt;on(<span class="string">'close'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($ser, $fd)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"client &#123;$fd&#125; closed\n"</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">$server-&gt;start();</span><br></pre></td></tr></table></figure>
<p>面向对象写法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ws</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $ws = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($host, $port)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;ws = <span class="keyword">new</span> swoole_websocket_server($host, $port);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;ws-&gt;on(<span class="string">'open'</span>, [<span class="keyword">$this</span>, <span class="string">'onOpen'</span>]);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;ws-&gt;on(<span class="string">'message'</span>, [<span class="keyword">$this</span>, <span class="string">'onMessage'</span>]);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;ws-&gt;on(<span class="string">'close'</span>, [<span class="keyword">$this</span>, <span class="string">'onClose'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">start</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;ws-&gt;start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">onOpen</span><span class="params">($server, $request)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"客户端 &#123;$request-&gt;fd&#125; 连接成功\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">onMessage</span><span class="params">($server, $frame)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"接收到客户端 &#123;$frame-&gt;fd&#125; 的消息： &#123;$frame-&gt;data&#125;\n"</span>;</span><br><span class="line">        $server-&gt;push($frame-&gt;fd, <span class="string">'服务端发送的消息：'</span> . date(<span class="string">'Y-m-d H:i:s'</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">onClose</span><span class="params">($server, $fd)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"客户端 &#123;$fd&#125; 退出啦~"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ws = <span class="keyword">new</span> Ws(<span class="string">'0.0.0.0'</span>, <span class="number">9502</span>);</span><br><span class="line">$ws-&gt;start();</span><br></pre></td></tr></table></figure>
<p>ws_client.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"ie=edge"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>swoole websocket 测试<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">        // 实例化 WebSocket 对象</span></span><br><span class="line"><span class="undefined">        var ws = new WebSocket('ws://192.168.10.15:9502');</span></span><br><span class="line"><span class="undefined">        </span></span><br><span class="line"><span class="undefined">        // 连接建立时触发</span></span><br><span class="line"><span class="undefined">        ws.onopen = function (evt) &#123;</span></span><br><span class="line"><span class="undefined">            console.log('connection open');</span></span><br><span class="line"><span class="undefined">            // 客户端发送消息给服务器</span></span><br><span class="line"><span class="undefined">            ws.send('hello swoole');</span></span><br><span class="line"><span class="undefined">        &#125;;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">        // 客户端接收服务端数据时触发</span></span><br><span class="line"><span class="undefined">        ws.onmessage = function (evt) &#123;</span></span><br><span class="line"><span class="undefined">            console.log("received message: " + evt.data);</span></span><br><span class="line"><span class="undefined">        &#125;;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">        // 连接关闭时触发</span></span><br><span class="line"><span class="undefined">        ws.onclose = function (evt) &#123;</span></span><br><span class="line"><span class="undefined">            console.log("connection closed.");</span></span><br><span class="line"><span class="undefined">        &#125;;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">        // 通信发生错误时触发</span></span><br><span class="line"><span class="undefined">        ws.onerror = function (evt) &#123;</span></span><br><span class="line"><span class="undefined">            console.log("error");</span></span><br><span class="line"><span class="undefined">        &#125;;</span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>运行结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[vagrant@docker-host server]$ php ws.php </span><br><span class="line">客户端 1 连接成功</span><br><span class="line">接收到客户端 1 的消息： hello swoole</span><br><span class="line">客户端 1 退出啦~客户端 2 连接成功</span><br><span class="line">接收到客户端 2 的消息： hello swoole</span><br><span class="line">客户端 2 退出啦~客户端 3 连接成功</span><br><span class="line">接收到客户端 3 的消息： hello swoole</span><br></pre></td></tr></table></figure></p>
<h2 id="异步Task"><a href="#异步Task" class="headerlink" title="异步Task"></a>异步Task</h2><p>Swoole提供了异步任务处理的功能，可以投递一个异步任务到 <code>task_worker</code> 进程池中执行，不影响 <code>worker</code> 进程请求的处理速度。要使用 <code>Task</code> 功能，必须先设置 <code>task_worker_num</code>，并且必须设置 Server 的 <code>onTask</code> 和 <code>onFinish</code> 事件回调函数。</p>
<p><strong>使用场景</strong></p>
<ul>
<li>执行耗时的操作（发送邮件、广播等）</li>
</ul>
<hr>
<p>基于上面的 WebSocket 服务器只需要增加 <code>onTask</code> 和 <code>onFinish</code> 2个事件回调函数即可。另外需要设置 task 进程数量，可以根据任务的耗时和任务量配置适量的 task 进程。</p>
<p>ws.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ws</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $ws = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($host, $port)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;ws = <span class="keyword">new</span> swoole_websocket_server($host, $port);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;ws-&gt;set([</span><br><span class="line">            <span class="string">'work_num'</span> =&gt; <span class="number">4</span>, <span class="comment">// 设置启动的worker进程数</span></span><br><span class="line">            <span class="string">'task_worker_num'</span> =&gt; <span class="number">4</span>, <span class="comment">// 设置Task进程的数量</span></span><br><span class="line">        ]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;ws-&gt;on(<span class="string">'open'</span>, [<span class="keyword">$this</span>, <span class="string">'onOpen'</span>]);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;ws-&gt;on(<span class="string">'message'</span>, [<span class="keyword">$this</span>, <span class="string">'onMessage'</span>]);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;ws-&gt;on(<span class="string">'task'</span>, [<span class="keyword">$this</span>, <span class="string">'onTask'</span>]);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;ws-&gt;on(<span class="string">'finish'</span>, [<span class="keyword">$this</span>, <span class="string">'onFinish'</span>]);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;ws-&gt;on(<span class="string">'close'</span>, [<span class="keyword">$this</span>, <span class="string">'onClose'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">start</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;ws-&gt;start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">onOpen</span><span class="params">($server, $request)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"客户端 &#123;$request-&gt;fd&#125; 连接成功\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">onMessage</span><span class="params">($server, $frame)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"接收到客户端 &#123;$frame-&gt;fd&#125; 的消息： &#123;$frame-&gt;data&#125;\n"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// todo 10s</span></span><br><span class="line">        $data = [</span><br><span class="line">            <span class="string">'fd'</span> =&gt; $frame-&gt;fd,</span><br><span class="line">            <span class="string">'value'</span> =&gt; <span class="string">'hello'</span>,</span><br><span class="line">        ];</span><br><span class="line">        <span class="comment">// 投递异步任务</span></span><br><span class="line">        $server-&gt;task($data);</span><br><span class="line"></span><br><span class="line">        $server-&gt;push($frame-&gt;fd, <span class="string">'服务端发送的消息：'</span> . date(<span class="string">'Y-m-d H:i:s'</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理异步任务</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">onTask</span><span class="params">($serv, $task_id, $from_id, $data)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"New AsyncTask[id=$task_id]"</span> . PHP_EOL;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 模拟耗时场景</span></span><br><span class="line">        sleep(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//返回任务执行的结果</span></span><br><span class="line">        $serv-&gt;finish(json_encode($data) . <span class="string">' -&gt; OK'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理异步任务返回的结果</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">onFinish</span><span class="params">($serv, $task_id, $data)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"AsyncTask[$task_id] Finish: $data"</span> . PHP_EOL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">onClose</span><span class="params">($server, $fd)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"客户端 &#123;$fd&#125; 退出啦~"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ws = <span class="keyword">new</span> Ws(<span class="string">'0.0.0.0'</span>, <span class="number">9502</span>);</span><br><span class="line">$ws-&gt;start();</span><br></pre></td></tr></table></figure>
<p>运行结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[vagrant@docker-host server]$ php ws.php </span><br><span class="line">客户端 1 连接成功</span><br><span class="line">接收到客户端 1 的消息： hello swoole</span><br><span class="line">New AsyncTask[id=0]</span><br><span class="line">AsyncTask[0] Finish: &#123;&quot;fd&quot;:1,&quot;value&quot;:&quot;hello&quot;&#125; -&gt; OK</span><br><span class="line">客户端 1 退出啦~客户端 2 连接成功</span><br><span class="line">接收到客户端 2 的消息： hello swoole</span><br><span class="line">New AsyncTask[id=1]</span><br><span class="line">AsyncTask[1] Finish: &#123;&quot;fd&quot;:2,&quot;value&quot;:&quot;hello&quot;&#125; -&gt; OK</span><br></pre></td></tr></table></figure></p>
<h2 id="毫秒定时器"><a href="#毫秒定时器" class="headerlink" title="毫秒定时器"></a>毫秒定时器</h2><p>swoole提供了类似JavaScript的 <code>setInterval/setTimeout</code> 异步高精度定时器，粒度为毫秒级。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 每隔2s触发一次</span></span><br><span class="line">swoole_timer_tick(<span class="number">2000</span>, <span class="function"><span class="keyword">function</span> <span class="params">($timer_id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"tick-2000ms\n"</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3s后执行此函数</span></span><br><span class="line">swoole_timer_after(<span class="number">3000</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"after 3000ms.\n"</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="异步文件IO"><a href="#异步文件IO" class="headerlink" title="异步文件IO"></a>异步文件IO</h2><h2 id="异步MySQL"><a href="#异步MySQL" class="headerlink" title="异步MySQL"></a>异步MySQL</h2><h2 id="异步Redis"><a href="#异步Redis" class="headerlink" title="异步Redis"></a>异步Redis</h2><h2 id="进程"><a href="#进程" class="headerlink" title="进程"></a>进程</h2><p>进程就是正在运行的程序的一个实例。Swoole增加了一个进程管理模块，用来替代PHP的pcntl扩展。需要注意的是Process进程在系统是非常昂贵的资源，创建进程消耗很大。另外创建的进程过多会导致进程切换开销大幅上升。</p>
<p>process.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建子进程</span></span><br><span class="line">$process = <span class="keyword">new</span> swoole_process(<span class="function"><span class="keyword">function</span> <span class="params">(swoole_process $worker)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 执行一个外部程序</span></span><br><span class="line">    $worker-&gt;exec(<span class="string">'/usr/local/php/bin/php'</span>, [</span><br><span class="line">        <span class="keyword">__DIR__</span> . <span class="string">'/../server/http_server.php'</span></span><br><span class="line">    ]);</span><br><span class="line">&#125;, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 开启进程</span></span><br><span class="line">$pid = $process-&gt;start();</span><br><span class="line"><span class="keyword">echo</span> $pid . PHP_EOL;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 子进程结束后进行回收</span></span><br><span class="line">swoole_process::wait();</span><br></pre></td></tr></table></figure>
<p>一个多进程使用场景：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">'process-start-time:'</span> . date(<span class="string">'H:i:s'</span>) . PHP_EOL;</span><br><span class="line"></span><br><span class="line">$processes = [];</span><br><span class="line">$urls = [</span><br><span class="line">    <span class="string">'http://www.baidu.com'</span>,</span><br><span class="line">    <span class="string">'http://www.sina.com.cn'</span>,</span><br><span class="line">    <span class="string">'http://www.qq.com'</span>,</span><br><span class="line">    <span class="string">'http://www.baidu.com?search=imooc'</span>,</span><br><span class="line">    <span class="string">'http://www.baidu.com?search=fun'</span>,</span><br><span class="line">    <span class="string">'http://www.baidu.com?search=sina'</span>,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">$count = count($urls);</span><br><span class="line"><span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; $count; $i++) &#123;</span><br><span class="line">    <span class="comment">// 多进程请求</span></span><br><span class="line">    $process = <span class="keyword">new</span> swoole_process(<span class="function"><span class="keyword">function</span> <span class="params">(swoole_process $worker)</span> <span class="title">use</span> <span class="params">($urls, $i)</span> </span>&#123;</span><br><span class="line">        $content = curlData($urls[$i]);</span><br><span class="line">        <span class="comment">// 向管道内写入数据</span></span><br><span class="line">        $worker-&gt;write($content); <span class="comment">// echo $content;</span></span><br><span class="line">    &#125;, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    $pid = $process-&gt;start();</span><br><span class="line">    $processes[$pid] = $process;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> ($processes <span class="keyword">as</span> $process) &#123;</span><br><span class="line">    <span class="comment">// 从管道中读取数据</span></span><br><span class="line">    <span class="keyword">echo</span> $process-&gt;read();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 模拟请求URL的内容</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> [type] $url</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">curlData</span><span class="params">($url)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// curl or file_get_contents</span></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $url . <span class="string">' - success'</span> . PHP_EOL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">'process-end-time:'</span> . date(<span class="string">'H:i:s'</span>) . PHP_EOL;</span><br></pre></td></tr></table></figure></p>
<p>运行结果:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[vagrant@docker-host process]$ php curl.php </span><br><span class="line">process-start-time:09:17:51</span><br><span class="line">http://www.baidu.com - success</span><br><span class="line">http://www.sina.com.cn - success</span><br><span class="line">http://www.qq.com - success</span><br><span class="line">http://www.baidu.com?search=imooc - success</span><br><span class="line">http://www.baidu.com?search=fun - success</span><br><span class="line">http://www.baidu.com?search=sina - success</span><br><span class="line">process-end-time:09:17:52</span><br></pre></td></tr></table></figure></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a href="https://wiki.swoole.com/" target="_blank" rel="noopener">Swoole 官方文档</a></li>
<li><a href="http://www.ruanyifeng.com/blog/2017/05/websocket.html" target="_blank" rel="noopener">WebSocket 教程</a></li>
<li><a href="https://coding.imooc.com/class/197.html" target="_blank" rel="noopener">Swoole入门到实战打造高性能赛事直播平台</a></li>
</ul>

            <!--[if lt IE 9]><script>document.createElement('audio');</script><![endif]-->
            <audio id="audio" loop="1" preload="auto" controls="controls" data-autoplay="false">
                <source type="audio/mpeg" src="">
            </audio>
            
                <ul id="audio-list" style="display:none">
                    
                        <li title='0' data-url='http://link.hhtjim.com/163/5146554.mp3'></li>
                    
                        <li title='1' data-url='http://link.hhtjim.com/qq/001faIUs4M2zna.mp3'></li>
                    
                </ul>
            
        </div>
        
    <div id='gitalk-container' class="comment link"
        data-ae='false'
        data-ci=''
        data-cs=''
        data-r=''
        data-o=''
        data-a=''
        data-d='false'
    >查看评论</div>


    </div>
    
        <div class='side'>
            <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#简介"><span class="toc-number">1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#安装"><span class="toc-number">2.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#快速起步"><span class="toc-number">3.</span> <span class="toc-text">快速起步</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#TCP-服务"><span class="toc-number">3.1.</span> <span class="toc-text">TCP 服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#UDP-服务"><span class="toc-number">3.2.</span> <span class="toc-text">UDP 服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HTTP-服务"><span class="toc-number">3.3.</span> <span class="toc-text">HTTP 服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#WebSocket-服务"><span class="toc-number">3.4.</span> <span class="toc-text">WebSocket 服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#异步Task"><span class="toc-number">3.5.</span> <span class="toc-text">异步Task</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#毫秒定时器"><span class="toc-number">3.6.</span> <span class="toc-text">毫秒定时器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#异步文件IO"><span class="toc-number">3.7.</span> <span class="toc-text">异步文件IO</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#异步MySQL"><span class="toc-number">3.8.</span> <span class="toc-text">异步MySQL</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#异步Redis"><span class="toc-number">3.9.</span> <span class="toc-text">异步Redis</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#进程"><span class="toc-number">3.10.</span> <span class="toc-text">进程</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#参考"><span class="toc-number">4.</span> <span class="toc-text">参考</span></a></li></ol>
        </div>
    
</div>


    </div>
</div>
</body>
<script src="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<script src="//lib.baomitu.com/jquery/1.8.3/jquery.min.js"></script>
<script src="/js/plugin.js"></script>
<script src="/js/diaspora.js"></script>
<link rel="stylesheet" href="/photoswipe/photoswipe.css">
<link rel="stylesheet" href="/photoswipe/default-skin/default-skin.css">
<script src="/photoswipe/photoswipe.min.js"></script>
<script src="/photoswipe/photoswipe-ui-default.min.js"></script>

<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>
    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <!--  Controls are self-explanatory. Order can be changed. -->
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>



<!-- Google Analytics -->
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-125814240-1', 'auto');
  ga('send', 'pageview');
</script>
<!-- End Google Analytics -->


</html>